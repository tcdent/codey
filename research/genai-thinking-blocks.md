# Thinking Blocks in genai 0.5.x

## Overview

This document analyzes the current thinking/reasoning block implementation in genai 0.5.x and proposes changes to properly support Anthropic's extended thinking with tool use.

## Current State (genai 0.5.x upstream)

### What exists

1. **`ContentPart::ThoughtSignature(String)`** - A simple string variant for Gemini thought signatures
2. **`captured_thought_signatures: Option<Vec<String>>`** - Captures signature strings only
3. **`captured_reasoning_content: Option<String>`** - Concatenated thinking text (loses block boundaries)
4. **`ChatStreamEvent::ThoughtSignatureChunk`** - Streams signature chunks
5. **`ChatStreamEvent::ReasoningChunk`** - Streams thinking content chunks

### The problem

For Anthropic tool use with extended thinking, you must pass back **complete thinking blocks** containing both:
- `thinking` - the reasoning content
- `signature` - cryptographic verification

The current implementation captures these separately and loses the mapping between content and signatures.

## Anthropic API Requirements

From [Anthropic's documentation](https://docs.anthropic.com/en/docs/build-with-claude/extended-thinking):

> "During tool use, you must pass `thinking` blocks back to the API, and you must include the complete unmodified block back to the API. This is critical for maintaining the model's reasoning flow and conversation integrity."

> "Full thinking content is encrypted and returned in the `signature` field. This field is used to verify that thinking blocks were generated by Claude when passed back to the API."

### Anthropic thinking block structure

Non-streaming response:
```json
{
  "type": "thinking",
  "thinking": "Let me analyze this step by step...",
  "signature": "WaUjzkypQ2mUEVM36O2TxuC06KN..."
}
```

Streaming events:
```json
// Content chunks
{"type": "content_block_delta", "delta": {"type": "thinking_delta", "thinking": "Let me..."}}

// Signature (sent just before content_block_stop)  
{"type": "content_block_delta", "delta": {"type": "signature_delta", "signature": "WaUjzkypQ2..."}}
```

### Tool use continuation

When continuing after a tool call, the assistant message must include complete thinking blocks:
```json
{
  "role": "assistant",
  "content": [
    {
      "type": "thinking",
      "thinking": "I need to read this file...",
      "signature": "WaUjzkypQ2mUEVM36O2TxuC06KN..."
    },
    {
      "type": "tool_use",
      "id": "toolu_01A09q90qw90lq917835lgs",
      "name": "read_file",
      "input": {"path": "foo.txt"}
    }
  ]
}
```

## Gemini vs Anthropic

| Feature | Gemini | Anthropic |
|---------|--------|-----------|
| Thinking content | Not exposed | Full text in `thinking` field |
| Signature | Opaque string only | Paired with thinking content |
| Tool use continuation | Pass signature | Pass complete thinking block |
| Current genai support | ✅ `ThoughtSignature(String)` | ❌ Missing |

## Proposed Changes

### Phase 1: Add ThinkingBlock alongside ThoughtSignature

Add a new struct and ContentPart variant without breaking existing code:

```rust
/// Anthropic thinking block with content and signature.
/// Required for tool use continuation with extended thinking.
/// 
/// See: https://docs.anthropic.com/en/docs/build-with-claude/extended-thinking#preserving-thinking-blocks
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ThinkingBlock {
    /// The thinking/reasoning content.
    pub thinking: String,
    /// Cryptographic signature for verification when passed back to API.
    pub signature: String,
}

pub enum ContentPart {
    // ... existing variants ...
    
    /// Gemini thought signature (opaque string, no content).
    #[from(ignore)]
    ThoughtSignature(String),
    
    /// Anthropic thinking block (content + signature).
    /// Must be preserved and passed back for tool use with extended thinking.
    #[from]
    ThinkingBlock(ThinkingBlock),
}
```

### Phase 2: Update Anthropic adapter

Modify the Anthropic streamer to:
1. Accumulate `thinking` content per block (not globally)
2. Capture `signature` when `signature_delta` arrives
3. Emit `ThinkingBlock` with both fields paired

```rust
// In AnthropicStreamer
struct InProgressThinking {
    thinking: String,
    signature: Option<String>,
}

// On thinking_delta: accumulate to current block's thinking
// On signature_delta: set current block's signature, emit ThinkingBlock
```

### Phase 3: Update StreamEnd captures

Add captured thinking blocks:
```rust
pub struct InterStreamEnd {
    // Existing
    pub captured_reasoning_content: Option<String>,
    pub captured_thought_signatures: Option<Vec<String>>,
    
    // New
    pub captured_thinking_blocks: Option<Vec<ThinkingBlock>>,
}
```

### Phase 4: Future - Deprecate ThoughtSignature

Eventually, `ThoughtSignature` could be replaced by `ThinkingBlock` with optional content:

```rust
pub struct ThinkingBlock {
    /// The thinking content (Some for Anthropic, None for Gemini).
    pub thinking: Option<String>,
    /// Cryptographic signature.
    pub signature: String,
}
```

This would be a breaking change and should be deferred to a major version.

## Our Current Patch

Our `thinking-blocks-signatures.patch` for genai 0.5.1 implements Phase 1-3:

- Adds `Thinking` struct (equivalent to proposed `ThinkingBlock`)
- Adds `ContentPart::Thinking(Thinking)` variant
- Modifies Anthropic streamer to capture paired thinking+signature
- Adds `captured_thinking_blocks` to StreamEnd

## References

- [Anthropic Extended Thinking Docs](https://docs.anthropic.com/en/docs/build-with-claude/extended-thinking)
- [Anthropic Streaming Messages API](https://docs.anthropic.com/en/api/messages-streaming)
- [genai PR #125 - Anthropic reasoning content](https://github.com/jeremychone/rust-genai/pull/125)
- [genai PR #121 - Gemini thoughts](https://github.com/jeremychone/rust-genai/pull/121)

## Action Items

1. [ ] Create branch on tcdent/rust-genai fork
2. [ ] Implement ThinkingBlock alongside ThoughtSignature
3. [ ] Update Anthropic adapter to capture paired blocks
4. [ ] Add tests demonstrating tool use with thinking blocks
5. [ ] Submit PR to upstream with documentation links
